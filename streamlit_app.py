import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from scipy.stats import shapiro

# --- –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ ---
st.set_page_config(
    page_title="–ù–∞—É–∫–æ–≤–∏–π –í–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–§–ú–§–ö–ù)",
    page_icon="‚öõÔ∏è",
    layout="wide"  # –®–∏—Ä–æ–∫–∏–π –º–∞–∫–µ—Ç –¥–ª—è —Å–∫–ª–∞–¥–Ω–∏—Ö —Ç–∞–±–ª–∏—Ü—å —ñ –≥—Ä–∞—Ñ—ñ–∫—ñ–≤
)

# --- –°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è (–∑–∞ –±–∞–∂–∞–Ω–Ω—è–º, –¥–ª—è –Ω–∞—É–∫–æ–≤–æ–≥–æ –≤–∏–≥–ª—è–¥—É) ---
plt.style.use('ggplot')
sns.set_style('whitegrid')

# --- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞ –æ–ø–∏—Å ---
st.title("‚öõÔ∏è –ê–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π –í–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –§–ú–§–ö–ù")
st.markdown("–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, –∞–Ω–∞–ª—ñ–∑—É —Ç–∞ –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–∏—Ö/–Ω–∞—É–∫–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö.")

# --- –ë—ñ—á–Ω–∞ –ø–∞–Ω–µ–ª—å: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ —Ñ—ñ–ª—å—Ç—Ä–∏ ---
with st.sidebar:
    st.header("–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö")
    
    # –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É
    uploaded_file = st.file_uploader(
        "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ CSV, XLSX –∞–±–æ TXT —Ñ–∞–π–ª:",
        type=['csv', 'xlsx', 'txt']
    )
    
    st.markdown("---")
    st.header("–ü—Ä–æ –ø—Ä–æ—î–∫—Ç")
    st.write("–°—Ç–≤–æ—Ä–µ–Ω–æ –¥–ª—è –§–∞–∫—É–ª—å—Ç–µ—Ç—É –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏, —Ñ—ñ–∑–∏–∫–∏ —Ç–∞ –∫–æ–º–ø'—é—Ç–µ—Ä–Ω–∏—Ö –Ω–∞—É–∫.")


# --- –û–±—Ä–æ–±–∫–∞ –¥–∞–Ω–∏—Ö ---
if uploaded_file is not None:
    # 1. –ó—á–∏—Ç—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
    try:
        if uploaded_file.name.endswith('.csv') or uploaded_file.name.endswith('.txt'):
            df = pd.read_csv(uploaded_file)
        elif uploaded_file.name.endswith('.xlsx'):
            df = pd.read_excel(uploaded_file)
        
        st.success(f"‚úÖ –§–∞–π–ª '{uploaded_file.name}' —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!")

    except Exception as e:
        st.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –∑—á–∏—Ç—É–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—É: {e}")
        st.stop() # –ó—É–ø–∏–Ω—è—î–º–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è, —è–∫—â–æ —î –ø–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è

    # --- 1. –û–≥–ª—è–¥ –¥–∞–Ω–∏—Ö ---
    st.header("1. –û–≥–ª—è–¥ —Ç–∞ –ü–æ–ø–µ—Ä–µ–¥–Ω—è –æ–±—Ä–æ–±–∫–∞")
    st.subheader("–¢–∞–±–ª–∏—Ü—è –¥–∞–Ω–∏—Ö")
    st.dataframe(df.head())
    
    col1, col2 = st.columns(2)
    with col1:
        st.metric(label="–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä—è–¥–∫—ñ–≤", value=df.shape[0])
    with col2:
        st.metric(label="–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Å—Ç–æ–≤–ø—Ü—ñ–≤", value=df.shape[1])
        
    st.subheader("–û–ø–∏—Å–æ–≤–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–ß–∏—Å–ª–∞)")
    st.dataframe(df.describe().T)


    # --- 2. –ù–∞—É–∫–æ–≤–∏–π/–°—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω–∏–π –ê–Ω–∞–ª—ñ–∑ ---
    st.header("2. –°—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω–∏–π –ê–Ω–∞–ª—ñ–∑")
    numerical_cols = df.select_dtypes(include=np.number).columns.tolist()
    
    if numerical_cols:
        st.subheader("–ê–Ω–∞–ª—ñ–∑ —Ä–æ–∑–ø–æ–¥—ñ–ª—É (–¢–µ—Å—Ç –Ω–∞ –Ω–æ—Ä–º–∞–ª—å–Ω—ñ—Å—Ç—å)")
        selected_col_stats = st.selectbox(
            "–û–±–µ—Ä—ñ—Ç—å –∑–º—ñ–Ω–Ω—É –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω–æ–≥–æ —Ç–µ—Å—Ç—É:",
            numerical_cols,
            key='shapiro_select'
        )
        
        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –Ω–æ—Ä–º–∞–ª—å–Ω—ñ—Å—Ç—å (–¢–µ—Å—Ç –®–∞–ø—ñ—Ä–æ-–í—ñ–ª–∫–∞)
        data = df[selected_col_stats].dropna()
        if len(data) >= 3: # –¢–µ—Å—Ç –≤–∏–º–∞–≥–∞—î –º—ñ–Ω—ñ–º—É–º 3 —Ç–æ—á–∫–∏ –¥–∞–Ω–∏—Ö
            stat, p = shapiro(data)
            alpha = 0.05
            
            st.code(f"–¢–µ—Å—Ç –®–∞–ø—ñ—Ä–æ-–í—ñ–ª–∫–∞ –¥–ª—è {selected_col_stats}:")
            st.write(f" –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ W: {stat:.4f}")
            st.write(f" P-–∑–Ω–∞—á–µ–Ω–Ω—è: {p:.4f}")
            
            if p > alpha:
                st.info("üí° **–í–∏—Å–Ω–æ–≤–æ–∫:** –ô–º–æ–≤—ñ—Ä–Ω–æ, –∑–º—ñ–Ω–Ω–∞ –º–∞—î –Ω–æ—Ä–º–∞–ª—å–Ω–∏–π —Ä–æ–∑–ø–æ–¥—ñ–ª (P > 0.05).")
            else:
                st.warning("‚ö†Ô∏è **–í–∏—Å–Ω–æ–≤–æ–∫:** –í—ñ–¥—Ö–∏–ª—è—î–º–æ –≥—ñ–ø–æ—Ç–µ–∑—É –ø—Ä–æ –Ω–æ—Ä–º–∞–ª—å–Ω–∏–π —Ä–æ–∑–ø–æ–¥—ñ–ª (P ‚â§ 0.05).")
        else:
            st.warning("–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö (–º–µ–Ω—à–µ 3-—Ö) –¥–ª—è —Ç–µ—Å—Ç—É –®–∞–ø—ñ—Ä–æ-–í—ñ–ª–∫–∞.")

        
        # --- 3. –ö–æ–º–ø'—é—Ç–µ—Ä–Ω—ñ –Ω–∞—É–∫–∏/–í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è ---
        st.header("3. –ö–æ—Ä–µ–ª—è—Ü—ñ–π–Ω–∏–π –ê–Ω–∞–ª—ñ–∑ —Ç–∞ –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è")
        
        # –¢–µ–ø–ª–æ–≤–∞ –∫–∞—Ä—Ç–∞ –∫–æ—Ä–µ–ª—è—Ü—ñ—ó
        corr = df[numerical_cols].corr()
        
        fig, ax = plt.subplots(figsize=(10, 8))
        sns.heatmap(corr, annot=True, fmt=".2f", cmap='coolwarm', ax=ax, linewidths=.5, linecolor='black')
        ax.set_title("–ú–∞—Ç—Ä–∏—Ü—è –∫–æ—Ä–µ–ª—è—Ü—ñ—ó —á–∏—Å–ª–æ–≤–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö")
        st.pyplot(fig)
        
    else:
        st.warning("–£ –Ω–∞–±–æ—Ä—ñ –¥–∞–Ω–∏—Ö –≤—ñ–¥—Å—É—Ç–Ω—ñ —á–∏—Å–ª–æ–≤—ñ —Å—Ç–æ–≤–ø—Ü—ñ –¥–ª—è —Ä–æ–∑—à–∏—Ä–µ–Ω–æ–≥–æ –∞–Ω–∞–ª—ñ–∑—É.")
        
else:
    # –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –∫–æ–ª–∏ —Ñ–∞–π–ª –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ
    st.info("–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –≤–∞—à—ñ –Ω–∞—É–∫–æ–≤—ñ –∞–±–æ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ (CSV, XLSX) —á–µ—Ä–µ–∑ –±—ñ—á–Ω—É –ø–∞–Ω–µ–ª—å, —â–æ–± –∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏.")
